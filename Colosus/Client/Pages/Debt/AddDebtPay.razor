@using Colosus.Client.Blazor.Services.Customer
@using Colosus.Client.Blazor.Services.Settings
@using Colosus.Entity.Concretes
@using Colosus.Entity.Concretes.CreateModel
@using Colosus.Entity.Concretes.DTO
@using Colosus.Operations.Abstracts
@using Colosus.Entity.Concretes.DatabaseModel
@inject ISettingsService settingsService
@inject IDataConverter dataConverter
@inject ICustomerService customerService

<Colosus.Client.Blazor.Components.ComboBox Empty="true"
                                           Source="payType"
                                           Ttemp="PaymentTypeDTO"
                                           ValueBinding="xd=> xd.Name"
                                           DataBinding="xd=> xd.PublicKey"
                                           SelectedValueChanged="(e)=> PaymentTypePublicKey = e.Value.ToString()"></Colosus.Client.Blazor.Components.ComboBox>

<Colosus.Client.Blazor.Components.ComboBox Empty="true"
                                           Source="currency"
                                           Ttemp="CurrencyDTO"
                                           ValueBinding="xd=> xd.Name"
                                           DataBinding="xd=> xd.PublicKey"
                                           SelectedValueChanged="(e)=> CurrencyPublicKey = e.Value.ToString()"></Colosus.Client.Blazor.Components.ComboBox>

<Colosus.Client.Blazor.Components.Entry Placeholder="Miktar" Type="Components.Entry.EntryTypeEnum.Number" TextChanged="(e)=> Price = decimal.Parse(e)"></Colosus.Client.Blazor.Components.Entry>

<Colosus.Client.Blazor.Components.Button Text="Tamam" OnClick="async()=> await Ekle()"></Colosus.Client.Blazor.Components.Button>
@code {
    public string CurrencyPublicKey { get; set; }
    public string PaymentTypePublicKey { get; set; }
    public decimal Price { get; set; }
    [Parameter] public string DebtPublicKey { get; set; }
    protected override async Task OnInitializedAsync()
    {
        var payRes = await settingsService.GetAllPaymentTypeForFirmPublicKey(AppState.SelectedFirmPublicKey);
        var curRes = await settingsService.GetAllCurrencyForFirmPublicKey(AppState.SelectedFirmPublicKey);

        if (payRes != null && payRes.Ok())
            payType = payRes.Data;

        if (curRes != null && curRes.Ok())
            currency = curRes.Data;

        StateHasChanged();
    }

    List<PaymentTypeDTO> payType { get; set; }
    List<CurrencyDTO> currency { get; set; }

    [Parameter] public Task CloseAction { get; set; }

    public async Task Ekle()
    {
        if (string.IsNullOrEmpty(CurrencyPublicKey) || string.IsNullOrEmpty(PaymentTypePublicKey))
        {
            AppState.AddMessage("Ödeme tipi yada para birimi boş bırakılamaz.");
            return;
        }

        if (CloseAction != null)
            CloseAction.Start();
    }
}
